/*
 * dir2xml v0.0.3
 * (c) hex7c0 http://supergiovane.tk/#/dir2xml
 * Licensed under GPLv3
 */
"use strict";function wrapper(a){function b(b,c){var d=crypto(a.hash),e=fs.readFileSync(c);return d.update(e),b?(b.hash=d.digest("hex"),b):"<hash>"+d.digest("hex")+"</hash>"}function c(b,c){var d;if(a.cache&&STORY.root===a.root){if(d=fs.statSync(a.root),d&&STORY.mtime===d.mtime.getTime()&&STORY.json===a.json&&STORY.hash===a.hash)return STORY.body;STORY=Object.create(null)}var e;return e=a.sync?g(a.root,b,""):dir_callback(a.root,b,""),c&&(e+=c),a.cache&&(d=fs.statSync(a.root),d&&(STORY.root=a.root,STORY.body=e,STORY.mtime=d.mtime.getTime(),STORY.json=a.json,STORY.hash=a.hash)),e}function d(b,c){var d;return d=a.sync?g(a.root,b,""):dir_callback(a.root,b,""),c&&(d+=c),d}function e(a,b,c,d,e,f,g){var j,l;return j=f?h++:i++,a[g]?l=a[g][j]=Object.create(null):(a[g]=Object.create(null),l=a[g][j]=Object.create(null)),l.name=c,l.ctime=e.ctime.getTime(),l.mtime=e.mtime.getTime(),f?l.type="dir":(l.atime=e.atime.getTime(),l.size=e.size,l=k(l,d),l.type="file"),[a,null]}function f(a,b,c,d,e,f){var g="",j="";return g=f?'<dir id="'+h++ +'">':'<file id="'+i++ +'">',g+="<name>"+c+"</name>",g+="<ctime>"+e.ctime.getTime()+"</ctime>",g+="<mtime>"+e.mtime.getTime()+"</mtime>",f?j="</dir>":(g+="<atime>"+e.atime.getTime()+"</atime>",g+="<size>"+e.size+"</size>",g+=k(!1,d),g+="</file>"),[a+g,b+j]}function g(b,c,d){var e=fs.statSync(b);if(e){var f=fs.readdirSync(b);if(f)for(var h=0,i=f.length;i>h;h++){var j=f[h];if(!(a.exclude&&a.exclude.test(j)||a.dotfiles&&"."===j[0])){var k=b+PATH.sep+j,m=fs.statSync(k);if(m){var n,o;if(m.isDirectory()){var p=l(c,d,j,k,m,!0,b);n=p[0],o=p[1];var c=g(k,n,o),d=""}else var p=l(c,d,j,k,m,!1,b),c=p[0],d=p[1]}}}}return d&&(c+=d),c}var h=0,i=0,j=d;a.cache&&(j=c);var k=b;a.hash||(k=function(a){return a?a:""});var l=f;return a.json?(l=e,j(Object.create(null),null)):j(header,footer)}try{var PATH=require("path"),crypto=require("crypto").createHash,fs=require("fs"),resolve=PATH.resolve}catch(MODULE_NOT_FOUND){console.error(MODULE_NOT_FOUND),process.exit(1)}var STORY=Object.create(null),header='<?xml version="1.0" encoding="UTF-8"?><home>',footer="</home>";module.exports=function(a,b){if(!a)throw new TypeError("root path required");var c=resolve(a);if("/"==c[c.length-1]&&(c=c.substr(0,c.length-1)),!fs.existsSync(a))throw new Error("path not exists");if(!fs.statSync(c).isDirectory())throw new Error("path is not a directory");var b=b||Object.create(null),d={root:c,exclude:b.exclude||!1,dotfiles:0==b.dotfiles?!1:!0,cache:0==b.cache?!1:!0,sync:!0,json:Boolean(b.json),hash:0==b.hash?!1:String(b.hash||"md5")};return wrapper(d)};
