/*
 * dir2xml v0.0.1
 * (c) hex7c0 http://supergiovane.tk/#/dir2xml
 * Licensed under GPLv3
 */
"use strict";function wrapper(a){function b(b,c){var d;if(a.cache&&STORY.root===a.root){if(d=fs.statSync(a.root),d&&STORY.mtime===d.mtime.getTime()&&STORY.json===a.json)return STORY.body;STORY=Object.create(null)}var e;return e=a.sync?f(a.root,b,""):dir_callback(a.root,b,""),c&&(e+=c),a.cache&&(d=fs.statSync(a.root),d&&(STORY.root=a.root,STORY.body=e,STORY.mtime=d.mtime.getTime(),STORY.json=a.json)),e}function c(b,c){var d;return d=a.sync?f(a.root,b,""):dir_callback(a.root,b,""),c&&(d+=c),d}function d(a,b,c,d,e,f,i){var j,k;j=f?g++:h++;try{k=a[i][j]=Object.create(null)}catch(l){a[i]=Object.create(null),k=a[i][j]=Object.create(null)}if(k.name=c,k.ctime=e.ctime.getTime(),k.mtime=e.mtime.getTime(),f)k.type="dir";else{var m=crypto("md5"),n=fs.readFileSync(d);m.update(n),k.atime=e.atime.getTime(),k.size=e.size,k.hash=m.digest("hex"),k.type="file"}return[a,null]}function e(a,b,c,d,e,f){var i="",j="";if(i=f?'<dir id="'+g++ +'">':'<file id="'+h++ +'">',i+="<name>"+c+"</name>",i+="<ctime>"+e.ctime.getTime()+"</ctime>",i+="<mtime>"+e.mtime.getTime()+"</mtime>",f)j="</dir>";else{var k=crypto("md5"),l=fs.readFileSync(d);k.update(l),i+="<atime>"+e.atime.getTime()+"</atime>",i+="<size>"+e.size+"</size>",i+="<hash>"+k.digest("hex")+"</hash>",i+="</file>"}return[a+i,b+j]}function f(b,c,d){var e=fs.statSync(b);if(e){var g=fs.readdirSync(b);if(g)for(var h=0,i=g.length;i>h;h++){var k=g[h];if(!(a.exclude&&a.exclude.test(k)||a.dotfiles&&"."===k[0])){var l=b+PATH.sep+k,m=fs.statSync(l);if(m){var n,o;if(m.isDirectory()){var p=j(c,d,k,l,m,!0,b);n=p[0],o=p[1];var c=f(l,n,o),d=""}else var p=j(c,d,k,l,m,!1,b),c=p[0],d=p[1]}}}}return d&&(c+=d),c}var g=0,h=0,i=c;a.cache&&(i=b);var j=e;return a.json?(j=d,i(Object.create(null),null)):i(header,footer)}try{var PATH=require("path"),crypto=require("crypto").createHash,fs=require("fs"),resolve=PATH.resolve}catch(MODULE_NOT_FOUND){console.error(MODULE_NOT_FOUND),process.exit(1)}var STORY=Object.create(null),header='<?xml version="1.0" encoding="UTF-8"?><home>',footer="</home>";module.exports=function(a,b){if(!a)throw new TypeError("root path required");var c=resolve(a);if("/"==c[c.length-1]&&(c=c.substr(0,c.length-1)),!fs.existsSync(a))throw new Error("path not exists");if(!fs.statSync(c).isDirectory())throw new Error("path is not a directory");var b=b||Object.create(null),d={root:c,exclude:b.exclude||!1,dotfiles:0==b.dotfiles?!1:!0,cache:0==b.cache?!1:!0,sync:!0,json:Boolean(b.json)};return wrapper(d)};
