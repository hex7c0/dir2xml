<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: index.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: index.js</h1>

    


    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>"use strict";
/**
 * @file dir2xml main
 * @module dir2xml
 * @package dir2xml
 * @subpackage main
 * @version 0.0.3
 * @author hex7c0 &lt;hex7c0@gmail.com>
 * @copyright hex7c0 2014
 * @license GPLv3
 */

/*
 * initialize module
 */
// import
try {
    var PATH = require('path');
    var crypto = require('crypto').createHash;
    var fs = require('fs');
    var resolve = PATH.resolve;
} catch (MODULE_NOT_FOUND) {
    console.error(MODULE_NOT_FOUND);
    process.exit(1);
}
// load
var STORY = Object.create(null);
var header = '&lt;?xml version="1.0" encoding="UTF-8"?>&lt;home>';
var footer = '&lt;/home>';

/*
 * functions
 */
/**
 * function wrapper for multiple require
 * 
 * @function wrapper
 * @param {Object} my - options
 * @return {Object}
 */
function wrapper(my) {

    /**
     * calculate hash of file
     * 
     * @function checksum
     * @param {Object|false} obj - object output
     * @param {String} file - absolute path name
     * @return {Object|String}
     */
    function checksum(obj, file) {

        var check = crypto(my.hash);
        var ff = fs.readFileSync(file);
        check.update(ff);
        if (obj) {
            obj.hash = check.digest('hex');
            return obj;
        }
        return '&lt;hash>' + check.digest('hex') + '&lt;/hash>';
    }

    /**
     * end of work with cache
     * 
     * @function cached
     * @param {String|Object} h - header
     * @param {String|null} f - footer
     * @return {String}
     */
    function cached(h, f) {

        var stat;
        // cache
        if (my.cache &amp;&amp; STORY.root === my.root) {

            stat = fs.statSync(my.root);
            if (stat &amp;&amp; STORY.mtime === stat.mtime.getTime() &amp;&amp; STORY.json === my.json
                    &amp;&amp; STORY.hash === my.hash) {
                return STORY.body;
            }
            STORY = Object.create(null);
        }
        // build
        var body;
        if (my.sync) {
            body = dir_sync(my.root, h, '');
        } else {
            body = dir_callback(my.root, h, '');
        }
        if (f) {
            body += f;
        }
        if (my.cache) {
            stat = fs.statSync(my.root);
            if (stat) {
                STORY.root = my.root;
                STORY.body = body;
                STORY.mtime = stat.mtime.getTime();
                STORY.json = my.json;
                STORY.hash = my.hash;
            }
        }
        return body;
    }

    /**
     * end of work
     * 
     * @function simple
     * @param {String|Object} h - header
     * @param {String|null} f - footer
     * @return {String}
     */
    function simple(h, f) {

        // build
        var body;
        if (my.sync) {
            body = dir_sync(my.root, h, '');
        } else {
            body = dir_callback(my.root, h, '');
        }
        if (f) {
            body += f;
        }
        return body;
    }

    /**
     * json builder
     * 
     * @function json
     * @param {String} head - header
     * @param {String} after - post header
     * @param {String} name - path name
     * @param {String} abs - absolute path name
     * @param {Object} stats - stats of file
     * @param {Boolean} dir - flag for directory
     * @param {String} root - root name
     * @return {Array}
     */
    function json(head, after, name, abs, stats, dir, root) {

        var index;
        var o;
        if (dir) {
            index = CCdir++;
        } else {
            index = CCfile++;
        }
        if (head[root]) {
            o = head[root][index] = Object.create(null);
        } else {
            head[root] = Object.create(null);
            o = head[root][index] = Object.create(null);
        }
        o.name = name;
        o.ctime = stats.ctime.getTime();
        o.mtime = stats.mtime.getTime();
        if (dir) {
            o.type = 'dir';
        } else {
            o.atime = stats.atime.getTime();
            o.size = stats.size;
            o = hash(o, abs);
            o.type = 'file';
        }
        return [ head, null ];
    }

    /**
     * xml builder
     * 
     * @function xml
     * @param {String} head - header
     * @param {String} after - post header
     * @param {String} name - path name
     * @param {String} abs - absolute path name
     * @param {Object} stats - stats of file
     * @param {Boolean} dir - flag for directory
     * @return {Array}
     */
    function xml(head, after, name, abs, stats, dir) {

        var h = '';
        var a = '';
        if (dir) {
            h = '&lt;dir id="' + CCdir++ + '">';
        } else {
            h = '&lt;file id="' + CCfile++ + '">';
        }
        h += '&lt;name>' + name + '&lt;/name>';
        h += '&lt;ctime>' + stats.ctime.getTime() + '&lt;/ctime>';
        h += '&lt;mtime>' + stats.mtime.getTime() + '&lt;/mtime>';
        if (dir) {
            a = '&lt;/dir>';
        } else {
            h += '&lt;atime>' + stats.atime.getTime() + '&lt;/atime>';
            h += '&lt;size>' + stats.size + '&lt;/size>';
            h += hash(false, abs);
            h += '&lt;/file>';
        }
        return [ head + h, after + a ];
    }

    // start sync
    /**
     * body
     * 
     * @function dir_sync
     * @param {String} prova - dir pathname
     * @param {String} head - header
     * @param {String} after - post header
     * @return {String}
     */
    function dir_sync(prova, head, after) {

        var stat = fs.statSync(prova);
        if (stat) {
            var files = fs.readdirSync(prova);
            if (files) {
                for (var i = 0, ii = files.length; i &lt; ii; i++) {
                    var file = files[i];
                    if (my.exclude &amp;&amp; my.exclude.test(file)) {
                        continue;
                    }
                    if (my.dotfiles &amp;&amp; file[0] === '.') {
                        continue;
                    }
                    var root = prova + PATH.sep + file;
                    var stats = fs.statSync(root);
                    if (stats) {
                        var hea;
                        var afte;
                        if (stats.isDirectory()) {
                            var r = build(head, after, file, root, stats, true, prova);
                            hea = r[0];
                            afte = r[1];
                            var head = dir_sync(root, hea, afte); // recursive
                            var after = '';
                        } else {
                            var r = build(head, after, file, root, stats, false, prova);
                            var head = r[0];
                            var after = r[1];
                        }
                    }
                }
            }
        }
        if (after) {
            head += after;
        }
        return head;
    }
    // end sync

    // start callback
    /**
     * body
     * 
     * @function dir_callback
     * @param {String} prova - dir pathname
     * @param {String} head - header
     * @param {String} after - post header
     * @return {String}
     */
    // function dir_callback(prova, head, after) {
    //
    // fs.stat(prova, function(err, stat) {
    //
    // if (err) {
    // return;
    // }
    // fs.readdir(prova, function(err, files) {
    //
    // if (err) {
    // return;
    // }
    // for (var i = 0, ii = files.length; i &lt; ii; i++) {
    // !function(file) {
    //
    // if (my.exclude &amp;&amp; my.exclude.test(file)) {
    // return;
    // }
    // if (my.dotfiles &amp;&amp; file[0] === '.') {
    // return;
    // }
    // var root = prova + PATH.sep + file;
    // fs.stat(root, function(err, stats) {
    //
    // if (err) {
    // return;
    // }
    // var hea;
    // var afte;
    // if (stats.isDirectory()) {
    // var r = build(head, after, file, root, stats,
    // true);
    // hea = r[0];
    // afte = r[1];
    // var head = mod_sync(root, hea, afte); // recursive
    // } else {
    // var r = build(head, after, file, root, stats,
    // false);
    // var head = r[0];
    // var after = r[1];
    // }
    // return;
    // });
    //
    // }(files[i]);
    // }
    // return;
    //
    // });
    // return;
    //
    // });
    // return head + after;
    // }
    // end callback
    var CCdir = 0;
    var CCfile = 0;

    // cache or not
    var end = simple;
    if (my.cache) {
        end = cached;
    }

    // hash
    var hash = checksum;
    if (!my.hash) {
        hash = function(obj) {

            if (obj) {
                return obj;
            }
            return '';
        };
    }

    // output
    var build = xml;
    if (my.json) {
        build = json;
        return end(Object.create(null), null);
    }
    return end(header, footer);
}

/**
 * options setting
 * 
 * @exports dir
 * @function dir
 * @param {String} root - root path
 * @param {Object} [options] - various options. Check README.md
 * @return {Object}
 */
module.exports = function dir(root, options) {

    if (!root) {
        throw new TypeError('root path required');
    }
    var r = resolve(root);
    if (r[r.length - 1] == '/') {
        r = r.substr(0, r.length - 1);
    }
    if (!fs.existsSync(root)) {
        throw new Error('path not exists');
    }
    if (!fs.statSync(r).isDirectory()) {
        throw new Error('path is not a directory');
    }
    var options = options || Object.create(null);
    var my = {
        root: r,
        exclude: options.exclude || false,
        dotfiles: options.dotfiles == false ? false : true,
        cache: options.cache == false ? false : true,
        /**
         * @todo: dir_callback. Boolean(options.sync)
         */
        sync: true,
        json: Boolean(options.json),
        hash: options.hash == false ? false : String(options.hash || 'md5')
    };
    return wrapper(my);
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Index</a></h2><h3>Modules</h3><ul><li><a href="module-dir2xml.html">dir2xml</a></li></ul>
</nav>

<br clear="both">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha9</a> on Sun Aug 31 2014 11:54:17 GMT+0200 (CEST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
